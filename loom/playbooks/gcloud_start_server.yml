---
- name: Start the Loom server.
  hosts: "{{lookup('env','SERVER_NAME')}}"
  become: yes
  become_method: sudo
  vars:
    ansible_python_interpreter: /opt/loom/bin/python # Use virtualenv
    remote_loom_settings_path: "{{ansible_env.HOME}}/{{lookup('env', 'LOOM_HOME_SUBDIR')}}"
    docker_tag: "{{lookup('env', 'DOCKER_TAG')}}"
  tasks:
  - name: Start the Loom server.
    docker_container: name=registry image={{docker_tag}} ports=8000:8000 volumes={{remote_loom_settings_path}}:/root/.loom restart_policy=always api_version=auto command='source /opt/loom/bin/activate; loom server set local; loom server start'
  - name: Start NGINX.
    docker_container: name=loom-nginx image=nginx network_mode=host volumes={{remote_loom_settings_path}}/nginx.conf:/etc/nginx/conf.d/default.conf,/var/log/nginx:/var/log/nginx,{{remote_loom_settings_path}}/ssl:/etc/nginx/ssl api_version=auto
