{
    "constants": {
        "samplename": "NA12878",
        "inputbamfilename": "NA12878.bam",
        "chromosome": "chr1",
	"dockermount":"/outside",
	"resourcedir": "${dockermount}/resources"
    },

    "applications": [
	{
            "id": "samtools",
            "docker_image": "isaacliao/samtools-0.1.19"
	},
	{
            "id": "gatk",
            "docker_image": "isaacliao/gatk-3.1.1"
	},
	{
            "id": "bwa",
            "docker_image": "isaacliao/bwa-0.7.4"
	},
	{
            "id": "picard",
            "docker_image": "isaacliao/picard-1.32"
	},
	{
            "id": "fix_bai_name",
            "docker_image": "isaacliao/fix_bai_name"
	},
	{
            "id": "tabix",
            "docker_image": "isaacliao/tabix-0.2.5"
	}
    ],

    "remote_file_locations":[
    {
        "id": "inputbamfilesource",
        "url": "https://scgs.blob.core.windows.net/public/NA12878.bam"
    },
    {
	"id": "outputbamdestination", 
        "account": "scgs",
        "container": "testcontainer",
        "blob_id": "${samplename}.recal.bam"
    },
    {
	"id": "vcffiledestination",
        "account": "scgs",
        "container": "testcontainer",
        "blob_id": "${samplename}.recal.vcf.gz"
    }
    ],
    

    "files": [
        {
            "comment": "This file will be used in several tasks in a session, but will not be saved to persistent storage.",
            "id": "inputbamfile",
            "local_path": "NA12878.bam",
	    "import_from": "inputbamfilesource"
        },
	{
            "id": "reference",
	    "local_path": "${resourcedir}/ucsc.hg19.fasta"
	},
	{
	    "id": "refindex",
	    "local_path": "${resourcedir}/ucsc.hg19.fasta.fai"
	},
	{
	    "id": "goldindels",
	    "local_path": "${resourcedir}/Mills_and_1000G_gold_standard.indels.hg19.vcf"
	},
	{
            "id": "phase1indels",
	    "local_path": "${resourcedir}/1000G_phase1.indels.hg19.vcf"
	},
	{
            "id": "dbsnp",
	    "local_path": "${resourcedir}/dbsnp_138.hg19.vcf"
	},
	{
	    "id": "hapmap",
	    "local_path": "${resourcedir}/hapmap_3.3.hg19.vcf"
	},
	{
	    "id": "omni",
	    "local_path": "${resourcedir}/1000G_omni2.5.hg19.vcf"
	},
	{
            "id": "phase1snps",
	    "local_path": "${resourcedir}/1000G_phase1.snps.high_confidence.hg19.vcf"
	},
	{
            "id": "GATKkey",
	    "local_path": "${resourcedir}/stanford.edu.key"
	},
        {
            "id": "outputbamfile",
            "local_path": "genome.recal.bam",
            "save_to": "outputbamdestination"
        },
	{
	    "id": "vcfcompressed",
	    "local_path": "genome.recal.vcf.gz",
	    "save_to": "vcffiledestination"
	}
    ],

    "sessions":[
        {
            "id": "mainsession",
            "input_file_ids": ["inputbamfile"],
            "output_file_ids": ["outputbamfile", "vcfcompressed"],
            "step_ids": [
		"bam2fq",
		"align",
		"samtobam",
		"mergeinputbams",
		"indexbam",
		"extractchromosome",
		"indexchromosomebam",
		"fixindexnamechromosome",
		"markduplicates",
		"indexnodupbam",
		"fixindexnamenodup",
		"findtargets",
		"realign",
		"fixmatepairs",
		"indexrealnbam",
		"fixindexrealn",
		"bqsr",
		"printreads",
		"indexbamrecal",
		"fixindexrecal",
		"haplotypecaller",
		"selectsnps",
		"selectindels",
		"combinesnpsindels",
		"mergechromosomebams",
		"combinevcfs",
		"selectsnpsforvqsr",
		"trainvqsrforsnps",
		"vqsrsnps",
		"selectindelsforvqsr",
		"trainvqsrindels",
		"vqsrindels",
		"mergerecalibratedvcfs",
		"compressvcf",
		"indexcompressedvcf"
            ]
        }
    ],

    "steps":[
        {
	    "comment": "Extract FastQ from bam",
            "id": "bam2fq",
            "command": "samtools bam2fq ${inputbamfilename} > ${samplename}.fastq",
            "application": "samtools"
        },
	{
            "id": "align",
	    "comment": "Realign FastQ, paired-end reads",
	    "constants": {
		"cores": "30",
		"ID": "0",
		"LB": "Library",
		"PL": "Illumina",
		"SM": "${samplename}"
	    },
            "command": "bwa mem -CMp -t $cores -R \"@RG\\tID:$ID\\tLB:$LB\\tPL:$PL\\tSM:$SM\" ${reference} ${samplename}.fastq > ${samplename}.bwa.sam",
	    "application": "bwa"
	},
	{
            "id": "samtobam",
            "comment": "Convert SAM to BAM",
            "command": "samtools view -Sbt ${refindex} -o ${samplename}.bw.bam ${samplename}.bwa.sam",
	    "application": "samtools"
	},
        {
            "id": "mergeinputbams",
            "comment": "Merge BAMs and sort",
            "command": "java -Xms5g -Xmx5g -jar /opt/picard-tools-1.32/MergeSamFiles.jar TMP_DIR=${dockermount} INPUT=${samplename}.bwa.bam USE_THREADING=true CREATE_INDEX=true OUTPUT=${samplename}.bwa.sorted.bam",
	    "application": "picard"
        },
        {
            "id": "indexbam",
            "comment": "Index BAM file",
            "command": "samtools index ${samplename}.bwa.sorted.bam",
	    "application": "samtools"
        },
        {
            "id": "extractchromosome",
            "comment": "Extract chromosome",
            "command": "samtools view ${samplename}.bwa.sorted.bam ${chromosome} -bo ${chromosome}.bam",
	    "application": "samtools"
	},
	{
            "id": "indexchromosomebam",
            "comment": "Index chromosome BAM file",
	    "command": "samtools index ${chromosome}.bam",
	    "application": "samtools"
	},
	{
            "id": "fixindexnamechromosome",
            "comment": "Fix index file name",
            "command": "python /opt/fix_bai_name.py ${chromosome}.bam.bai",
	    "application": "fix_bai_name"
	},
	{
            "id": "markduplicates",
            "comment": "Mark duplicates",
            "command": "java -Xms5g -Xmx5g -jar /opt/picard-tools-1.32/MarkDuplicates.jar TMP_DIR=${dockermount} I=${chromosome}.bam O=${chromosome}.nodup.bam M= VALIDATION_STRINGENCY=SILENT ASSUME_SORTED=true REMOVE_DUPLICATES=false",
	    "application": "picard"
	},
	{
            "id": "indexnodupbam",
	    "comment": "Index BAM file",
            "command": "samtools index ${chromosome}.nodup.bam",
	    "application": "samtools"
	},
	{
            "id": "fixindexnamenodup",
            "comment": "Fix index file name",
	    "command": "python /opt/fix_bai_name.py ${chromosome}.nodup.bam.bai",
	    "application": "fix_bai_name"
	},
	{
            "id": "findtargets",
            "comment": "Find realignment targets",
            "constants": {"threads": "30"},
            "command": "java -Xms8g -Xmx8g -jar /opt/GenomeAnalysisTK.jar -T RealignerTargetCreator -I ${chromosome}.nodup.bam -R ${reference} -o ${chromosome}.realn.intervals -L ${chromosome} -known ${goldindels} -known ${phase1indels} -et NO_ET -K ${GATKkey} -nt ${threads}",
	    "application": "gatk"
	},
	{
            "id": "realign",
	    "comment": "Realign targeted regions",
            "command": "java -Xms8g -Xmx8g -Djava.io.tmpdir=${dockermount} -jar /opt/GenomeAnalysisTK.jar -T IndelRealigner -I ${chromosome}.nodup.bam -R ${reference} -o ${chromosome}.realn.bam -L ${chromosome} -targetIntervals ${chromosome}.realn.intervals -known ${goldindels} -known ${phase1indels} -et NO_ET -K ${GATKkey}",
	    "application": "gatk"
	},
        {
            "id": "fixmatepairs",
	    "comment": "Fix mate pairs and read order",
            "command": "java -Xms8g -Xmx8g -jar /opt/picard-tools-1.32/FixMateInformation.jar TMP_DIR=${dockermount} INPUT=${chromosome}.realn.bam VALIDATION_STRINGENCY=SILENT SORT_ORDER=coordinate",
	    "application": "picard"
	},
	{
            "id": "indexrealnbam",
            "comment": "Index BAM file",
	    "command": "samtools index ${chromosome}.realn.bam",
	    "application": "samtools"
	},
	{
            "id": "fixindexrealn",
	    "comment": "Fix index file name",
	    "command": "python /opt/fix_bai_name.py ${chromosome}.realn.bam.bai",
	    "application": "fix_bai_name"
	},
	{
            "id": "bqsr",
	    "comment": "Recalibrate base quality",
            "constants": {"threads": "30"},
            "command": "java -Xms5g -Xmx5g -jar /opt/GenomeAnalysisTK.jar -T BaseRecalibrator -I ${chromosome}.realn.bam -R ${reference} -o ${chromosome}.recal.grp -knownSites ${goldindels} -knownSites ${phase1indels} -knownSites ${dbsnp} -K ${GATKkey} -nct ${threads}",
	    "application": "gatk"
	},
	{
            "id": "printreads",
	    "comment": "Print reads",
            "constants": {"threads": "30"},
            "command": "java -Xms5g -Xmx5g -jar /opt/GenomeAnalysisTK.jar -R ${reference} -I ${chromosome}.realn.bam -o ${chromosome}.recal.bam -T PrintReads -BQSR ${chromosome}.recal.grp -K /srv/gs1/software/gatk/GATKkey/stanford.edu.key -nct ${threads}",
	    "application": "gatk"
	},
	{
            "id": "indexbamrecal",
	    "comment": "Index BAM file",
	    "command": "samtools index ${chromosome}.recal.bam",
	    "application": "samtools"
	},
	{
            "id": "fixindexrecal",
            "comment": "Fix index file name",
            "command": "python /opt/fix_bai_name.py ${chromosome}.recal.bam.bai",
	    "application": "fix_bai_name"
        },
	{
            "id": "haplotypecaller",
	    "comment": "Call SNPs and indels using HaplotypeCaller",
            "application": "gatk",
            "constants": {"threads": "30"},
            "command": "java -Xmx8g -Xms8g -Djava.io.tmpdir=${dockermount} -jar /opt/GenomeAnalysisTK.jar -T HaplotypeCaller -R ${reference} -I ${chromosome}.recal.bam --dbsnp ${dbsnp} -o ${chromosome}.gatk.vcf.hc.vcf -stand_call_conf 20.0 -stand_emit_conf 10.0 --genotyping_mode DISCOVERY -nct ${threads}"
	},
	{
            "id": "selectsnps",
	    "comment": "Selecting SNPs",
            "application": "gatk",
            "command": "java -Xmx8g -Xms8g -jar /opt/GenomeAnalysisTK.jar -T SelectVariants -R ${reference} -V ${chromosome}.gatk.vcf.hc.vcf -o ${chromosome}.gatk.vcf.snp -selectType SNP"
	},
	{
            "id": "selectindels",
            "comment": "Selecting indels",
            "application": "gatk",
            "command": "java -Xmx8g -Xms8g -jar /opt/GenomeAnalysisTK.jar -T SelectVariants -R ${reference} -V ${chromosome}.gatk.vcf.hc.vcf -o ${chromosome}.gatk.vcf.indel -selectType INDEL"
        },
        {
            "id": "combinesnpsindels",
	    "comment": "Combining SNPs and indels",
            "application": "gatk",
            "command": "java -Xmx8g -Xms8g -jar /opt/GenomeAnalysisTK.jar -R ${reference} -T CombineVariants --variant ${chromosome}.gatk.vcf.snp --variant ${chromosome}.gatk.vcf.indel -o ${chromosome}.gatk.vcf"
	},
	{
            "id": "mergechromosomebams",
            "comment":"Merge BAMs",
	    "application": "picard",
            "command":"java -Xms5g -Xmx5g -jar /opt/picard-tools-1.32/MergeSamFiles.jar TMP_DIR=${dockermount} INPUT=${chromosome}.recal.bam USE_THREADING=true CREATE_INDEX=true OUTPUT=${outputbamfile}"
        },
        {
            "id": "combinevcfs",
            "comment":"Combine VCFs",
	    "application": "gatk",
            "command":"java -Xmx8g -Xms8g -jar /opt/GenomeAnalysisTK.jar -R ${dockermount}/${reference} -T CombineVariants --variant:VCF ${dockermount}/${chromosome}.gatk.vcf -o ${samplename}.gatk.vcf"
	},
        {
            "id": "selectsnpsforvqsr",
            "comment": "Select SNPs for VQSR",
            "application": "gatk",
            "command": "java -Xmx6g -Xms6g -jar /opt/GenomeAnalysisTK.jar -T SelectVariants -R ${reference} -V ${samplename}.gatk.vcf -o ${samplename}.snp.vcf -selectType SNP"
	},
	{
            "id": "trainvqsrforsnps",
            "comment": "Train VQSR recalibrator for SNPs",
            "application": "gatk",
            "constants": {"threads": "30"},
            "command": "java -Xmx6g -Xms6g -jar /opt/GenomeAnalysisTK.jar -T VariantRecalibrator -R ${reference} -input ${samplename}.snp.vcf -resource:hapmap,known=false,training=true,truth=true,prior=15.0 ${hapmap} -resource:omni,known=false,training=true,truth=true,prior=12.0 ${omni} -resource:1000G,known=false,training=true,truth=false,prior=10.0 ${phase1snps} -resource:dbsnp,known=true,training=false,truth=false,prior=2.0 ${dbsnp} -an DP -an QD -an FS -an MQRankSum -an ReadPosRankSum -tranche 100.0 -tranche 99.9 -tranche 99.0 -tranche 90.0 -mode SNP -recalFile ${samplename}.tmp.snp.vcf -tranchesFile ${samplename}.tranches.gatk.snp.recal.csv -nt ${threads} -rscriptFile ${samplename}.gatk.recal.snp.R"
	},
	{
            "id": "vqsrsnps",
	    "comment": "Apply VQSR recalibration to SNPs",
            "application": "gatk",
            "command": "java -Xmx3g -Xms3g -jar /opt/GenomeAnalysisTK.jar -T ApplyRecalibration -R ${reference} -input ${samplename}.snp.vcf --ts_filter_level 99.0 -tranchesFile ${samplename}.tranches.gatk.snp.recal.csv -recalFile ${samplename}.tmp.snp.vcf -o ${samplename}.vqsr.snp.vcf --mode SNP"
	},
	{
            "id": "selectindelsforvqsr",
	    "comment": "Select indels for VQSR",
	    "application": "gatk",
	    "command": "java -Xmx6g -Xms6g -jar /opt/GenomeAnalysisTK.jar -T SelectVariants -R ${reference} -V ${samplename}.gatk.vcf -o ${samplename}.indel.vcf -selectType INDEL"
	},
	{
            "id": "trainvqsrindels",
	    "comment": "Train VQSR recalibrator for indels",
	    "application": "gatk",
            "constants": {"threads": "30"},
            "command": "java -Xmx6g -Xms6g -jar /opt/GenomeAnalysisTK.jar -T VariantRecalibrator -R ${reference} -input ${samplename}.indel.vcf -resource:mills,known=true,training=true,truth=true,prior=12.0 ${goldindels} -an DP -an FS -an MQRankSum -an ReadPosRankSum -tranche 100.0 -tranche 99.9 -tranche 99.0 -tranche 90.0 -mode INDEL -recalFile ${samplename}.tmp.indel.vcf -tranchesFile ${samplename}.tranches.gatk.indel.recal.csv --maxGaussians 4 -nt ${threads} -rscriptFile ${samplename}.gatk.recal.indel.R"
	},
	{
            "id": "vqsrindels",
	    "comment": "Apply VQSR recalibration to indels",
	    "application": "gatk",
	    "command": "java -Xmx6g -Xms6g -jar /opt/GenomeAnalysisTK.jar -T ApplyRecalibration -R ${reference} -input ${samplename}.indel.vcf --ts_filter_level 99.0 -tranchesFile ${samplename}.tranches.gatk.indel.recal.csv -recalFile ${samplename}.tmp.indel.vcf -o ${samplename}.vqsr.indel.vcf --mode INDEL"
	},
	{
            "id": "mergerecalibratedvcfs",
            "comment": "Merge recalibrated VCFs",
            "application": "gatk",
            "command": "java -Xmx8g -Xms8g -jar /opt/GenomeAnalysisTK.jar -R ${reference} -T CombineVariants --variant:VCF ${samplename}.vqsr.indel.vcf --variant:VCF ${samplename}.vqsr.snp.vcf -o genome.recal.vcf"
	},
	{
            "id": "compressvcf",
	    "comment": "Compress VCF",
	    "application": "tabix",
            "command": "bgzip -fc genome.recal.vcf > ${vcfcompressed}"
        },
	{
	    "id": "indexcompressedvcf",
            "comment": "Index compressed VCF",
	    "application": "tabix",
	    "command": "tabix -p vcf ${vcfcompressed}"
        }
    ],

    "pipeline": {
        "files": [
            "inputbamfile",
            "reference",
	    "refindex",
	    "goldindels",
            "phase1indels",
            "dbsnp",
	    "hapmap",
	    "omni",
            "phase1snps",
            "GATKkey",
            "outputbamfile",
	    "vcfcompressed"
        ],

        "sessions": [
            "mainsession"
        ]
    }
}
